<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <title>Finance dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Courier New', Courier, monospace;
            background: #fffef7;
            color: #000;
            margin: 0;
            padding: 30px 20px 40px;
            line-height: 1.4;
        }
        h1 {
            font-size: 48px;
            font-weight: 900;
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: -2px;
        }
        h2 {
            font-size: 30px;
            font-weight: 900;
            margin: 0 0 15px 0;
            text-transform: uppercase;
            letter-spacing: -1px;
        }
        .container {
            max-width: 1300px;
            margin: 0 auto;
        }
        .card {
            background: #fff;
            border: 5px solid #000;
            padding: 25px;
            margin-bottom: 25px;
        }
        .main-nav {
            position: sticky;
            top: 10px;
            z-index: 100;
            display: flex;
            flex-wrap: wrap;
            gap: 0;
            border: 5px solid #000;
            margin-bottom: 35px;
            background: #fffef7;
        }
        .main-nav a {
            text-decoration: none;
            padding: 15px 20px;
            background: #fff;
            border-right: 5px solid #000;
            color: #000;
            font-size: 16px;
            font-weight: 900;
            text-transform: uppercase;
        }
        .main-nav a:last-child {
            border-right: none;
        }
        .main-nav a.active {
            background: #000;
            color: #fff;
        }
        .main-nav a:hover {
            background: #e1bee7;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 18px;
        }
        .summary-item {
            border: 3px solid #000;
            padding: 18px;
            text-transform: uppercase;
            font-weight: 900;
            border-radius: 8px;
        }
        .summary-item span {
            display: block;
            font-size: 26px;
            margin-top: 8px;
        }
        .summary-item .top-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            letter-spacing: 1px;
            margin-bottom: 6px;
            width: 100%;
            gap: 10px;
            flex-wrap: nowrap;
        }
        .summary-item .top-line .label {
            font-size: 14px;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .summary-item .badge {
            padding: 2px 10px;
            border: 3px solid #000;
            font-size: 10px;
            font-weight: 900;
            background: #b86f1f;
            color: #fffef7;
            border-radius: 6px;
        }
        .summary-income { background: #c8e6c9; }
        .summary-expense { background: #ffcdd2; }
        .summary-net { background: #bbdefb; }
        .summary-count { background: #fff4c3; }
        .summary-uncat { background: #f7d8ae; }
        .flex {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }
        .flex > .card {
            flex: 1 1 350px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
        }
        th, td {
            padding: 10px 12px;
            border: 3px solid #000;
            text-align: left;
            word-break: break-word;
        }
        th {
            background: #000;
            color: #fff;
            font-weight: 900;
            text-transform: uppercase;
        }
        .amount-pos {
            color: #2d5f3f;
            background: #c8e6c9;
            padding: 2px 6px;
            font-weight: 900;
        }
        .amount-pos::before {
            content: '+';
        }
        .amount-neg {
            color: #7f2c2c;
            background: #ffcdd2;
            padding: 2px 6px;
            font-weight: 900;
        }
        canvas {
            width: 100%;
            border: 3px solid #000;
            background: #fafafa;
        }
        .month-accordion {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 10px;
        }
        .month-panel {
            border: 3px solid #000;
            border-radius: 12px;
            background: #fff;
        }
        .month-panel summary {
            cursor: pointer;
            list-style: none;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            font-weight: 900;
            text-transform: uppercase;
        }
        .month-panel summary::-webkit-details-marker {
            display: none;
        }
        .month-label {
            font-size: 16px;
        }
        .month-metrics {
            display: flex;
            gap: 18px;
            font-size: 14px;
        }
        .month-metrics span {
            min-width: 120px;
            display: inline-block;
        }
        .month-income { color: #2d5f3f; }
        .month-expense { color: #7f2c2c; }
        .month-net { color: #000; }
        .month-details {
            padding: 0 20px 20px;
        }
        .month-table th, .month-table td {
            border-color: #000;
        }
        .month-table td:nth-child(1),
        .month-table td:nth-child(3),
        .month-table td:nth-child(4) {
            white-space: nowrap;
            width: 120px;
        }
        .month-table td:nth-child(2) {
            width: auto;
            white-space: normal;
        }
        .empty-note {
            margin: 10px 0;
            font-weight: 900;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
<div class="container">
    {% set active_page = 'dashboard' %}
    {% include '_navbar.html' %}

    <div class="card">
        <h1>Finance dashboard</h1>
        <div class="summary-grid">
            <div class="summary-item summary-income">
                Skupni prihodki
                <span>{{ "%.2f"|format(total_income) }} €</span>
            </div>
            <div class="summary-item summary-expense">
                Skupni odhodki
                <span>{{ "%.2f"|format(total_expense) }} €</span>
            </div>
            <div class="summary-item summary-net">
                Neto stanje
                <span>{{ "%.2f"|format(overall_net) }} €</span>
            </div>
            <div class="summary-item summary-count">
                Transakcije
                <span>{{ total_transactions }}</span>
            </div>
            <div class="summary-item summary-uncat">
                <div class="top-line">
                    <span class="label">NEKATEGORIZIRANE</span>
                    <span class="badge">{{ uncategorized_count }}</span>
                </div>
                <span>{{ "%.2f"|format(uncategorized_total) }} €</span>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Monthly cashflow</h2>
        <canvas id="monthlyChart" height="320"></canvas>
    </div>

    <div class="flex">
        <div class="card">
            <h2>Spending by category</h2>
            <canvas id="spendingPieChart" height="260"></canvas>
        </div>
        <div class="card">
            <h2>Income by category</h2>
            <canvas id="incomePieChart" height="260"></canvas>
        </div>
    </div>

    <div class="card monthly-card">
        <h2>Mesečni povzetek</h2>
        <div class="month-accordion">
            {% for row in summary_rows %}
                {% set month_key = "%d-%02d"|format(row["Year"], row["Month"]) %}
                <details class="month-panel">
                    <summary>
                        <span class="month-label">{{ row["MonthName"]|title }} {{ row["Year"] }}</span>
                        <span class="month-metrics">
                            <span class="month-income">{{ "%.2f"|format(row["Income"]) }} €</span>
                            <span class="month-expense">-{{ "%.2f"|format(row["Expense"]) }} €</span>
                            <span class="month-net">{{ "%.2f"|format(row["Net"]) }} €</span>
                        </span>
                    </summary>
                    <div class="month-details">
                        {% set month_tx = monthly_transactions.get(month_key, []) %}
                        {% if month_tx %}
                            <table class="month-table">
                                <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Opis</th>
                                    <th>Znesek</th>
                                    <th>Stanje</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for tx in month_tx %}
                                    <tr>
                                        <td>{{ tx.date }}</td>
                                        <td>{{ tx.description }}</td>
                                        {% if tx.amount >= 0 %}
                                            <td class="amount-pos">{{ "%.2f"|format(tx.amount) }}</td>
                                        {% else %}
                                            <td class="amount-neg">{{ "%.2f"|format(tx.amount) }}</td>
                                        {% endif %}
                                        <td>{{ "%.2f"|format(tx.balance) }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p class="empty-note">Ni transakcij za ta mesec.</p>
                        {% endif %}
                    </div>
                </details>
            {% else %}
                <p class="empty-note">Ni podatkov.</p>
            {% endfor %}
        </div>
    </div>
</div>

<script id="dashboard-data" type="application/json">
{{ {
    "labels": labels,
    "incomeData": income_data,
    "expenseData": expense_data,
    "spendingCategories": spending_categories,
    "spendingAmounts": spending_amounts,
    "incomeCategories": income_categories,
    "incomeAmounts": income_amounts
}|tojson }}
</script>
<script>
    const dataElement = document.getElementById('dashboard-data');
    let parsedData = {
        labels: [],
        incomeData: [],
        expenseData: [],
        spendingCategories: [],
        spendingAmounts: [],
        incomeCategories: [],
        incomeAmounts: [],
    };
    if (dataElement) {
        try {
            parsedData = JSON.parse(dataElement.textContent || '{}');
        } catch (err) {
            console.error('Failed to parse dashboard data', err);
        }
    }
    const {
        labels,
        incomeData,
        expenseData,
        spendingCategories,
        spendingAmounts,
        incomeCategories,
        incomeAmounts,
    } = parsedData;

    const monthlyCanvas = document.getElementById('monthlyChart');
    if (monthlyCanvas && window.Chart) {
        const ctx = monthlyCanvas.getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Income',
                        data: incomeData,
                        borderColor: '#2d5f3f',
                        backgroundColor: 'rgba(200, 230, 201, 0.5)',
                        borderWidth: 4,
                        tension: 0,
                        fill: true
                    },
                    {
                        label: 'Expenses',
                        data: expenseData,
                        borderColor: '#7f2c2c',
                        backgroundColor: 'rgba(255, 205, 210, 0.5)',
                        borderWidth: 4,
                        tension: 0,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        labels: {
                            color: '#000',
                            font: { family: "'Courier New', monospace", weight: 'bold' }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#000', font: { family: "'Courier New', monospace" } },
                        grid: { color: '#ccc', lineWidth: 2 }
                    },
                    y: {
                        ticks: { color: '#000', font: { family: "'Courier New', monospace" } },
                        grid: { color: '#ccc', lineWidth: 2 }
                    }
                }
            }
        });
    }

    function renderPie(canvasId, labels, data) {
        const canvas = document.getElementById(canvasId);
        if (!canvas || !window.Chart || labels.length === 0) return;
        const ctx = canvas.getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: [
                        '#ffcdd2', '#f8bbd0', '#e1bee7', '#d1c4e9',
                        '#c5cae9', '#bbdefb', '#b3e5fc', '#b2ebf2',
                        '#b2dfdb', '#c8e6c9', '#dcedc8', '#f0f4c3'
                    ],
                    borderColor: '#000',
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#000',
                            font: { family: "'Courier New', monospace", weight: 'bold' },
                            padding: 15
                        }
                    }
                }
            }
        });
    }

    renderPie('spendingPieChart', spendingCategories, spendingAmounts);
    renderPie('incomePieChart', incomeCategories, incomeAmounts);
</script>
</body>
</html>
